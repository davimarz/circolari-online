name: Robot Circolari

on:
  schedule:
    # Esegui ogni giorno alle 8:00 UTC (9:00 Italia)
    - cron: '0 8 * * *'
  workflow_dispatch:  # Permette esecuzione manuale

jobs:
  scarica-circolari:
    runs-on: ubuntu-latest
    
    env:
      PYTHON_VERSION: '3.10'
    
    steps:
    - name: â¬‡ï¸ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Installa dipendenze
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ¤– Esegui robot circolari (ModalitÃ  Ibrida)
      run: |
        echo "=========================================="
        echo "ğŸ¤– AVVIO ROBOT CIRCOLARI - MODALITÃ€ IBRIDA"
        echo "=========================================="
        echo "â° Data/ora: $(date)"
        echo "ğŸ’° ModalitÃ : IBRIDA (PostgreSQL + SQLite)"
        echo "ğŸ’¾ Database PostgreSQL: Railway interno"
        echo "ğŸ’¾ Database SQLite: circolari.db"
        echo "ğŸ‘ï¸  VisibilitÃ  Streamlit: âœ… IMMEDIATA"
        echo "=========================================="
        
        python leggi_circolari.py
        
        echo "=========================================="
        echo "âœ… ROBOT COMPLETATO"
        echo "=========================================="
    
    - name: ğŸ“Š Verifica circolari salvate
      if: always()
      run: |
        echo "ğŸ” VERIFICA CIRCOLARI SALVATE"
        echo "================================"
        
        if [ -f "robot_report.json" ]; then
          echo "ğŸ“„ Leggo report di esecuzione..."
          
          VISIBILE=$(python -c "
import json
try:
    with open('robot_report.json', 'r') as f:
        data = json.load(f)
    
    if 'streamlit_app' in data:
        visibile = data['streamlit_app']['visibile']
        motivo = data['streamlit_app']['motivo']
        print(f'VISIBILE: {visibile}')
        print(f'MOTIVO: {motivo}')
        
        if visibile == 'SI':
            # Estrai numero circolari
            if 'risultati' in data:
                processate = data['risultati'].get('circolari_processate', 0)
                print(f'CIRCOLARI_PROCESSATE: {processate}')
            
            print('STATO: SUCCESSO_VISIBILE')
            exit(0)
        else:
            print('STATO: SUCCESSO_NON_VISIBILE')
            exit(1)
    else:
        print('STATO: REPORT_INCOMPLETO')
        exit(2)
        
except Exception as e:
    print(f'ERRORE: {e}')
    exit(3)
" 2>&1)
          
          echo "$VISIBILE"
          
          # Controlla stato
          if echo "$VISIBILE" | grep -q "STATO: SUCCESSO_VISIBILE"; then
            echo "ğŸ‰ Le circolari sono VISIBILI su Streamlit!"
            CIRC_PROC=$(echo "$VISIBILE" | grep "CIRCOLARI_PROCESSATE" | cut -d: -f2 | xargs)
            echo "ğŸ“Š Circolari processate: $CIRC_PROC"
            echo "ğŸ”— Vai su: https://circolari-online-production.up.railway.app"
          elif echo "$VISIBILE" | grep -q "STATO: SUCCESSO_NON_VISIBILE"; then
            echo "âš ï¸  Robot completato ma circolari NON visibili"
            echo "ğŸ’¡ Usa il pulsante 'Sincronizza da backup' nell'app"
          else
            echo "âŒ Errore nella verifica"
          fi
        else
          echo "âŒ Nessun report generato"
        fi
        
        echo "================================"
    
    - name: ğŸ“¤ Upload risultati
      uses: actions/upload-artifact@v4
      with:
        name: robot-output-${{ github.run_id }}
        path: |
          circolari.db
          robot_report.json
          circolari.json
          errore_robot.json
        retention-days: 30
    
    - name: ğŸ“ Riepilogo esecuzione
      if: always()
      run: |
        echo "ğŸ“Š RIEPILOGO ESECUZIONE"
        echo "========================"
        
        if [ -f "robot_report.json" ]; then
          echo "âœ… Report generato: robot_report.json"
          echo "ğŸ’¾ Database SQLite: circolari.db"
          echo "ğŸ“ˆ Statistiche: circolari.json"
          
          # Leggi dati dal report
          CIRC_PROC=$(python -c "
import json
try:
    with open('robot_report.json', 'r') as f:
        data = json.load(f)
    processate = data.get('risultati', {}).get('circolari_processate', 0)
    print(processate)
except:
    print('0')
" 2>&1)
          
          echo "ğŸ”¢ Circolari processate: $CIRC_PROC"
          
          # Controlla visibilitÃ 
          VISIBILE=$(python -c "
import json
try:
    with open('robot_report.json', 'r') as f:
        data = json.load(f)
    if 'streamlit_app' in data and data['streamlit_app']['visibile'] == 'SI':
        print('SI')
    else:
        print('NO')
except:
    print('ERRORE')
" 2>&1)
          
          echo "ğŸ‘ï¸  Visibile su Streamlit: $VISIBILE"
          
          if [ "$VISIBILE" = "SI" ]; then
            echo "ğŸ¯ Tutto funziona! Le circolari sono giÃ  visibili."
            echo "ğŸŒ App Streamlit: https://circolari-online-production.up.railway.app"
          else
            echo "âš ï¸  Le circolari potrebbero non essere visibili."
            echo "ğŸ’¡ Soluzione: Usa il pulsante 'Sincronizza da backup' nell'app Streamlit"
          fi
        else
          echo "âŒ Esecuzione fallita o report non generato"
          if [ -f "errore_robot.json" ]; then
            echo "ğŸ“„ Report errore: errore_robot.json"
          fi
        fi
        
        echo "========================"
    
    - name: ğŸ”” Notifica successo
      if: success()
      run: |
        echo "âœ… Robot eseguito con successo!"
        echo "ğŸ“… Data: $(date '+%d/%m/%Y %H:%M')"
        echo "ğŸ’¾ Database ibrido: PostgreSQL + SQLite"
        echo "ğŸ“Š Report: robot_report.json"
        echo "ğŸ“ˆ Statistiche: circolari.json"
        echo "ğŸŒ App Streamlit: https://circolari-online-production.up.railway.app"
    
    - name: âš ï¸ Notifica errore
      if: failure()
      run: |
        echo "âŒ Robot fallito!"
        echo "ğŸ“… Data: $(date '+%d/%m/%Y %H:%M')"
        echo "ğŸ“„ Controlla i logs per dettagli"
        echo "ğŸ’¾ File errore: errore_robot.json (se disponibile)"
        echo "ğŸ’¡ Soluzione: Usa backup SQLite con sincronizzazione manuale"
