name: Robot Circolari

on:
  schedule:
    # Esegui ogni giorno alle 8:00 UTC (9:00 Italia)
    - cron: '0 8 * * *'
  workflow_dispatch:  # Permette esecuzione manuale

jobs:
  scarica-circolari:
    runs-on: ubuntu-latest
    
    env:
      PYTHON_VERSION: '3.10'
    
    steps:
    - name: â¬‡ï¸ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Installa dipendenze
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ¤– Esegui robot circolari
      run: |
        echo "=========================================="
        echo "ğŸ¤– AVVIO ROBOT CIRCOLARI"
        echo "=========================================="
        echo "â° Data/ora: $(date)"
        echo "ğŸ’° ModalitÃ : GRATUITA (SQLite locale)"
        echo "ğŸ’¾ Database: circolari.db"
        echo "=========================================="
        
        python leggi_circolari.py
        
        echo "=========================================="
        echo "âœ… ROBOT COMPLETATO"
        echo "=========================================="
    
    - name: ğŸ“¤ Upload risultati
      uses: actions/upload-artifact@v4
      with:
        name: robot-output-${{ github.run_id }}
        path: |
          circolari.db
          robot_report.json
          circolari.json
          errore_robot.json
        retention-days: 30
    
    - name: ğŸ“ Riepilogo esecuzione
      if: always()
      run: |
        echo "ğŸ“Š RIEPILOGO ESECUZIONE"
        echo "========================"
        
        if [ -f "robot_report.json" ]; then
          echo "âœ… Report generato: robot_report.json"
          echo "ğŸ’¾ Database: circolari.db"
          echo "ğŸ“ˆ Statistiche: circolari.json"
        else
          echo "âŒ Esecuzione fallita"
          if [ -f "errore_robot.json" ]; then
            echo "ğŸ“„ Report errore: errore_robot.json"
          fi
        fi
        
        echo "========================"
    
    - name: ğŸ”” Notifica successo
      if: success()
      run: |
        echo "âœ… Robot eseguito con successo!"
        echo "ğŸ“… Data: $(date '+%d/%m/%Y %H:%M')"
        echo "ğŸ’¾ Database: circolari.db"
        echo "ğŸ“Š Report: robot_report.json"
        echo "ğŸ“ˆ Statistiche: circolari.json"
    
    - name: âš ï¸ Notifica errore
      if: failure()
      run: |
        echo "âŒ Robot fallito!"
        echo "ğŸ“… Data: $(date '+%d/%m/%Y %H:%M')"
        echo "ğŸ“„ Controlla i logs per dettagli"
        echo "ğŸ’¾ File errore: errore_robot.json (se disponibile)"
